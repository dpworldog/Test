name: VPS with Public Tmate & Backup

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max allowed by GitHub

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: ğŸ“¦ Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y zip unzip

    - name: ğŸ” Restore Backup if Exists
      run: |
        mkdir -p data
        if [ -f .backup/latest.zip ]; then
          echo "ğŸ”„ Restoring from backup..."
          unzip -o .backup/latest.zip -d .
        else
          echo "âŒ No backup found. Starting fresh."
        fi

    - name: ğŸ§‘â€ğŸ’» Start Public Tmate SSH Session
      uses: mxschmitt/action-tmate@v3

    - name: ğŸ’¾ Save Backup on Exit
      if: always()
      run: |
        mkdir -p .backup
        zip -r .backup/latest.zip data/
        echo "âœ… Backup saved to .backup/latest.zip"

    - name: ğŸ“¤ Push Backup to GitHub
      if: always()
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ” Auto backup after tmate session"
        file_pattern: ".backup/latest.zip"
        
